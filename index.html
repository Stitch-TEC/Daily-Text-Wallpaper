<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Text Wallpaper V10</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Lora:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4a90e2;
            --primary-hover: #357abd;
            --bg: #121212;
            --panel: #1e1e1e;
            --text: #ffffff;
            --text-muted: #888888;
            --border: #333;
            --tab-active: #2c2c2c;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .main-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            max-width: 800px;
        }

        h1 { margin-bottom: 20px; font-size: 1.5rem; text-align: center; color: #ddd; letter-spacing: -0.5px; }

        /* --- SETTINGS CARD --- */
        .settings-card {
            width: 100%;
            max-width: 500px;
            background: var(--panel);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            overflow: hidden;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        /* --- TABS --- */
        .tabs {
            display: flex;
            background: #181818;
            border-bottom: 1px solid var(--border);
        }
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: white;
            border-bottom-color: var(--primary);
            background: var(--tab-active);
        }
        
        .tab-content { padding: 25px; display: none; }
        .tab-content.active { display: block; }

        /* --- PREVIEW AREA --- */
        .preview-area {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        canvas {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-height: 80vh; 
            border: 1px solid #333;
        }

        /* --- ACTION AREA --- */
        .action-card {
            width: 100%;
            max-width: 500px;
            background: var(--panel);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border);
            text-align: center;
        }

        /* --- FORM ELEMENTS --- */
        .input-group { margin-bottom: 20px; }
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }

        label { 
            display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.75rem; 
            color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; justify-content: space-between;
        }
        
        textarea, input[type="text"], select {
            width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid var(--border);
            color: white; border-radius: 8px; box-sizing: border-box; font-size: 14px; 
            font-family: inherit; transition: border 0.2s;
        }

        input[type="color"] {
            width: 100%; height: 42px; padding: 2px; background: #2a2a2a;
            border: 1px solid var(--border); border-radius: 8px; cursor: pointer;
        }

        textarea:focus, input:focus, select:focus { outline: none; border-color: var(--primary); background: #333; }
        textarea { resize: vertical; min-height: 100px; line-height: 1.5; }

        input[type=range] {
            width: 100%; margin: 8px 0; accent-color: var(--primary);
            height: 4px; background: #444; border-radius: 5px; outline: none; cursor: pointer;
        }
        
        button {
            width: 100%; padding: 14px; background-color: var(--primary);
            color: white; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 600;
            cursor: pointer; margin-top: 8px; transition: background 0.2s, transform 0.1s;
        }
        button:hover { background-color: var(--primary-hover); }
        button:active { transform: scale(0.98); }
        
        button.secondary { background-color: #333; margin-top: 10px; font-size: 0.85rem; padding: 10px; border: 1px solid #444; }
        button.secondary:hover { background-color: #444; }
        button.share-btn { background-color: #2e7d32; display: none; } 

        /* POPPING UPLOAD BUTTON */
        input[type="file"] { display: none; }
        .file-upload {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            padding: 20px; background: linear-gradient(145deg, #252525, #2a2a2a);
            border: 2px dashed var(--primary); color: var(--primary);
            font-weight: 700; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 1px;
            border-radius: 12px; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 5px;
        }
        .file-upload:hover {
            background: var(--primary); color: white; border-color: var(--primary);
            transform: translateY(-3px); box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);
        }
        .file-upload:active { transform: translateY(-1px); }

        .separator { width: 100%; height: 1px; background: #333; margin: 25px 0; }

        footer { width: 100%; padding: 40px 20px; text-align: center; margin-top: auto; }
        footer p { font-size: 0.85rem; color: var(--text-muted); margin: 0; line-height: 1.5; }
        footer a { color: var(--text-muted); text-decoration: none; border-bottom: 1px dotted #555; margin: 0 5px; }
        footer a:hover { color: var(--primary); border-bottom-style: solid; }
        .disclaimer { font-size: 0.7rem; color: #555; margin-top: 15px; display: block; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <h1>Daily Text Wallpaper</h1>

    <div class="settings-card">
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('tab-content')">1. Content üìù</button>
            <button class="tab-btn" onclick="openTab('tab-style')">2. Style üé®</button>
        </div>

        <div id="tab-content" class="tab-content active">
            <div class="input-group">
                <label>1. Select Language üåé</label>
                <select id="langSelect" onchange="fetchDailyText()">
                    <option value="en">English</option>
                    <option value="es">Espa√±ol (Spanish)</option>
                    <option value="ja">Êó•Êú¨Ë™û (Japanese)</option>
                    <option value="fr">Fran√ßais (French)</option>
                    <option value="pt">Portugu√™s (Portuguese)</option>
                    <option value="de">Deutsch (German)</option>
                    <option value="it">Italiano (Italian)</option>
                </select>
            </div>

            <div class="input-group">
                <label>2. Choose Background</label>
                <label for="imgUpload" class="file-upload"><span>üì∏ Upload Photo</span></label>
                <input type="file" id="imgUpload" accept="image/*">
            </div>

            <div class="input-group">
                <label>3. Edit Text</label>
                <textarea id="textInput" placeholder="Loading text..." style="min-height: 100px;"></textarea>
                <button class="secondary" onclick="fetchDailyText()">üîÑ Refresh Daily Text</button>
            </div>
        </div>

        <div id="tab-style" class="tab-content">
            <div class="grid-row">
                <div>
                    <label>Format</label>
                    <select id="formatSelect" onchange="draw()">
                        <option value="mobile">Mobile (9:16)</option>
                        <option value="desktop">Desktop (16:9)</option>
                    </select>
                </div>
                <div>
                    <label>Font</label>
                    <select id="fontSelect">
                        <option value="Inter">Clean (Sans)</option>
                        <option value="Lora">Elegant (Serif)</option>
                        <option value="Dancing Script">Script (Fancy)</option>
                        <option value="Noto Sans JP">Japanese (JP)</option>
                    </select>
                </div>
            </div>

            <div class="grid-row">
                <div>
                    <label>Text Size <span id="textSizeLabel" style="font-weight:normal;">36</span></label>
                    <input type="range" id="textSizeRange" min="20" max="150" step="1" value="36">
                </div>
                <div>
                    <label>Image Position ‚ÜïÔ∏è</label>
                    <input type="range" id="bgPosRange" min="0" max="100" step="1" value="50">
                </div>
            </div>

            <div class="grid-row">
                <div>
                    <label>Date Label</label>
                    <select id="datePosSelect" onchange="draw()">
                        <option value="floating">Floating Top</option>
                        <option value="inline-top">Inline Top</option>
                        <option value="inline-bottom">Inline Bottom</option>
                        <option value="none">None</option>
                    </select>
                </div>
                <div>
                    <label>Alignment</label>
                     <select id="alignSelect" onchange="draw()">
                        <option value="center">Center</option>
                        <option value="left">Left</option>
                    </select>
                </div>
            </div>

            <div class="separator"></div>
            <label style="margin-bottom:15px; color:white;">‚ú® Effects & Overlay</label>

            <div class="input-group">
                <label>Text Shadow ‚ö´</label>
                <input type="range" id="shadowRange" min="0" max="50" step="1" value="20">
            </div>

            <div class="grid-row">
                <div>
                    <label>Overlay Color</label>
                    <input type="color" id="overlayColorPicker" value="#000000">
                </div>
                <div>
                    <label>Overlay Opacity <span id="overlayLabel" style="font-weight:normal;">40%</span></label>
                    <input type="range" id="overlayRange" min="0" max="0.9" step="0.1" value="0.4">
                </div>
            </div>
        </div>
    </div>

    <div class="preview-area"><canvas id="wallpaperCanvas"></canvas></div>

    <div class="action-card">
        <label style="text-align:center; justify-content:center; margin-bottom:15px;">Ready to share?</label>
        <button id="shareBtn" class="share-btn" onclick="shareWallpaper()">Share Image üì§</button>
        <button onclick="downloadWallpaper()">Download Image ‚¨á</button>
    </div>
</div>

<footer>
    <p>Questions? <a href="mailto:Daily-Text-Wallpaper@stitchtec.dev">Email</a> ‚Ä¢ <a href="https://stitchtec.dev/" target="_blank">Website</a></p>
    <span class="disclaimer">Unofficial tool. Daily Text content ¬© Watch Tower Bible and Tract Society of Pennsylvania.</span>
</footer>

<script>
    const canvas = document.getElementById('wallpaperCanvas');
    const ctx = canvas.getContext('2d');
    const textInput = document.getElementById('textInput');
    const imgUpload = document.getElementById('imgUpload');
    const shareBtn = document.getElementById('shareBtn');
    
    // Inputs
    const overlayRange = document.getElementById('overlayRange');
    const overlayColorPicker = document.getElementById('overlayColorPicker');
    const textSizeRange = document.getElementById('textSizeRange');
    const bgPosRange = document.getElementById('bgPosRange');
    const shadowRange = document.getElementById('shadowRange'); 
    
    const formatSelect = document.getElementById('formatSelect');
    const fontSelect = document.getElementById('fontSelect');
    const langSelect = document.getElementById('langSelect');
    const datePosSelect = document.getElementById('datePosSelect');
    const alignSelect = document.getElementById('alignSelect');

    const overlayLabel = document.getElementById('overlayLabel');
    const textSizeLabel = document.getElementById('textSizeLabel');
    
    const LANG_CONFIG = {
        'en': { region: 'r1', code: 'lp-e', urlPart: 'en', locale: 'en-US' },
        'es': { region: 'r4', code: 'lp-s', urlPart: 'es', locale: 'es-ES' },
        'de': { region: 'r10', code: 'lp-x', urlPart: 'de', locale: 'de-DE' },
        'fr': { region: 'r30', code: 'lp-f', urlPart: 'fr', locale: 'fr-FR' },
        'it': { region: 'r6', code: 'lp-i', urlPart: 'it', locale: 'it-IT' },
        'pt': { region: 'r5', code: 'lp-t', urlPart: 'pt', locale: 'pt-BR' },
        'ja': { region: 'r7', code: 'lp-j', urlPart: 'ja', locale: 'ja-JP' } 
    };

    let currentImage = new Image();
    currentImage.crossOrigin = "Anonymous"; 
    currentImage.onload = function() { draw(); };
    currentImage.src = 'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?q=80&w=1920&auto=format&fit=crop'; 

    if (navigator.share) shareBtn.style.display = "block";

    window.openTab = function(tabName) {
        Array.from(document.getElementsByClassName("tab-content")).forEach(c => { c.style.display = "none"; c.classList.remove("active"); });
        Array.from(document.getElementsByClassName("tab-btn")).forEach(b => b.classList.remove("active"));
        document.getElementById(tabName).style.display = "block";
        document.getElementById(tabName).classList.add("active");
        event.currentTarget.classList.add("active");
    }

    async function fetchDailyText() {
        const lang = langSelect.value;
        const config = LANG_CONFIG[lang] || LANG_CONFIG['en'];
        if(lang === 'ja') fontSelect.value = 'Noto Sans JP';
        textInput.value = "Fetching...";
        
        const today = new Date();
        const targetUrl = `https://wol.jw.org/${config.urlPart}/wol/dt/${config.region}/${config.code}/${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
        
        const proxies = [
            { url: `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`, type: 'html' },
            { url: `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`, type: 'json' },
            { url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}`, type: 'html' }
        ];

        let success = false;
        for (const proxy of proxies) {
            if (success) break;
            try {
                const res = await fetch(proxy.url);
                if (!res.ok) throw new Error();
                let html = proxy.type === 'json' ? (await res.json()).contents : await res.text();
                if (!html || html.length < 50) throw new Error();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                let theme = doc.querySelector(".themeScrp")?.textContent.trim() || "";
                let body = doc.querySelector(".bodyTxt")?.textContent.trim() || "";
                
                if (theme && body) {
                    theme = theme.replace(/^[\w\u00C0-\u00FF\u3000-\u303F]+,\s[\w\u00C0-\u00FF\u3000-\u303F]+\s\d+/, '').trim();
                    textInput.value = `${theme}\n\n${body}`;
                    draw(); success = true;
                }
            } catch (e) {}
        }
        if (!success) { textInput.value = "Could not auto-load text.\nPlease copy/paste manually."; draw(); }
    }

    // --- MAIN DRAW FUNCTION ---
    function draw() {
        if (!currentImage.complete && currentImage.src) return; 

        const format = formatSelect.value;
        const bgPos = bgPosRange.value;
        
        textSizeLabel.innerText = textSizeRange.value;
        overlayLabel.innerText = Math.round(overlayRange.value * 100) + "%";

        if (format === 'desktop') { canvas.width = 1920; canvas.height = 1080; } 
        else { canvas.width = 1080; canvas.height = 1920; }
        
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // --- DRAW IMAGE ---
        const hRatio = canvas.width / currentImage.width;
        const vRatio = canvas.height / currentImage.height;
        const ratio = Math.max(hRatio, vRatio);
        const imgW = currentImage.width * ratio;
        const imgH = currentImage.height * ratio;
        const centerX = (canvas.width - imgW) / 2;
        const maxScroll = imgH - canvas.height; 
        
        let shiftY = maxScroll > 0 ? -(maxScroll * (bgPos / 100)) : (canvas.height - imgH) / 2;
        ctx.drawImage(currentImage, 0, 0, currentImage.width, currentImage.height, centerX, shiftY, imgW, imgH);
        
        // --- COLORED OVERLAY ---
        const hex = overlayColorPicker.value;
        const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
        ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${overlayRange.value})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // --- TEXT RENDERING ---
        const fontSize = parseInt(textSizeRange.value);
        ctx.fillStyle = "white";
        ctx.textBaseline = "middle";
        
        // Dynamic Shadow
        const shadowVal = parseInt(shadowRange.value);
        if(shadowVal > 0) {
            ctx.shadowColor = "rgba(0,0,0,0.8)";
            ctx.shadowBlur = shadowVal;
            ctx.shadowOffsetX = shadowVal / 4;
            ctx.shadowOffsetY = shadowVal / 4;
        } else {
            ctx.shadowColor = "transparent";
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
        }

        ctx.font = `bold ${fontSize}px '${fontSelect.value}', sans-serif`;

        const config = LANG_CONFIG[langSelect.value] || LANG_CONFIG['en'];
        const dateStr = new Date().toLocaleDateString(config.locale, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        let mainText = textInput.value;
        let datePos = datePosSelect.value;

        if (datePos === 'floating') {
            ctx.textAlign = "center"; 
            const dateSize = Math.max(24, fontSize * 0.7);
            ctx.font = `bold ${dateSize}px '${fontSelect.value}', sans-serif`;
            const headerY = format === 'desktop' ? canvas.height * 0.12 : canvas.height * 0.10;
            ctx.fillText(dateStr, canvas.width / 2, headerY);
            ctx.font = `bold ${fontSize}px '${fontSelect.value}', sans-serif`;
        } else if (datePos === 'inline-top') {
            mainText = `${dateStr}\n\n${mainText}`;
        } else if (datePos === 'inline-bottom') {
            mainText = `${mainText}\n\n${dateStr}`;
        }

        ctx.textAlign = alignSelect.value; 
        let xPos = alignSelect.value === 'left' ? (format === 'desktop' ? 100 : 80) : canvas.width / 2;
        const maxTextWidth = format === 'desktop' ? 1200 : canvas.width - 160;
        
        wrapText(ctx, mainText, xPos, canvas.height / 2, maxTextWidth, fontSize * 1.5, langSelect.value);
    }

    function wrapText(context, text, x, y, maxWidth, lineHeight, lang) {
        const paragraphs = text.split(/\r\n|\r|\n/);
        let allLines = [];
        const isJapanese = (lang === 'ja');
        const splitChar = isJapanese ? '' : ' ';

        for (let i = 0; i < paragraphs.length; i++) {
            if (paragraphs[i].trim() === '') { allLines.push(''); continue; }
            const tokens = paragraphs[i].split(splitChar);
            let line = '';
            for(let n = 0; n < tokens.length; n++) {
                const joiner = isJapanese ? '' : ' ';
                const testLine = line + tokens[n] + joiner;
                if (context.measureText(testLine).width > maxWidth && n > 0) {
                    allLines.push(line); line = tokens[n] + joiner;
                } else { line = testLine; }
            }
            allLines.push(line);
        }
        const totalHeight = allLines.length * lineHeight;
        let startY = y - (totalHeight / 2) + (lineHeight / 2);
        for(let k = 0; k < allLines.length; k++) {
            context.fillText(allLines[k], x, startY + (k * lineHeight));
        }
    }

    imgUpload.addEventListener('change', function(e) {
        if(e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                const img = new Image();
                img.onload = function() { currentImage = img; draw(); }
                img.src = evt.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    function downloadWallpaper() {
        try {
            const link = document.createElement('a');
            link.download = `daily_text_${formatSelect.value}_${new Date().toISOString().slice(0,10)}.jpg`;
            link.href = canvas.toDataURL("image/jpeg", 0.9);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        } catch (e) { fallbackOpen(); }
    }

    async function shareWallpaper() {
        try {
            canvas.toBlob(async (blob) => {
                const file = new File([blob], "daily_text_wallpaper.jpg", { type: "image/jpeg" });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: 'Daily Text', text: 'Daily Text Wallpaper' });
                } else throw new Error();
            }, 'image/jpeg', 0.9);
        } catch (error) { downloadWallpaper(); }
    }

    function fallbackOpen() {
        const win = window.open();
        win.document.write('<body style="margin:0;background:#111;display:flex;justify-content:center;align-items:center;height:100vh;"><img src="' + canvas.toDataURL("image/jpeg", 0.9) + '" style="max-width:100%;max-height:100%;box-shadow:0 0 20px black;"/></body>');
    }

    [textInput, overlayRange, overlayColorPicker, textSizeRange, bgPosRange, shadowRange, formatSelect, datePosSelect, alignSelect].forEach(el => el.addEventListener('input', draw));
    fontSelect.addEventListener('change', function() { document.fonts.load(`bold 40px '${this.value}'`).then(() => draw()); });
    langSelect.addEventListener('change', fetchDailyText);

    fetchDailyText();
    document.fonts.ready.then(() => draw());
</script>
</body>
</html>